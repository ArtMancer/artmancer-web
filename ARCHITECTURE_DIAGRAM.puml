@startuml Architecture Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam componentStyle rectangle

title ArtMancer System Architecture

package "Frontend (React/Next.js)" {
  component [Frontend Client] as Frontend
}

package "API Gateway (CPU)" {
  component [API Gateway] as Gateway
  note right of Gateway
    Cold-start: <1s
    Request routing
    CORS handling
  end note
}

package "Modal Volumes (Persistent Storage)" {
  database "Qwen Model\nCache" as QwenVol
  database "FastSAM Model\nCache" as FastSAMVol
  database "BiRefNet Model\nCache" as BiRefNetVol
  note right of QwenVol
    Reduces cold-start
    from 20-60s to 1-3s
  end note
}

package "Segmentation Service (T4 GPU, 16GB VRAM)" {
  component [Segmentation Service] as SegService
  note right of SegService
    FastSAM: 1-3s
    BiRefNet: 3-5s
    Timeout: 5 minutes
  end note
}

package "Image Utils Service (CPU)" {
  component [Image Utils Service] as ImageUtils
  note right of ImageUtils
    Object extraction
    Image processing
  end note
}

package "Job Manager Service" {
  component [Job Manager] as JobManager
  note right of JobManager
    Task coordination
    Progress tracking
    Debug session management
  end note
}

package "A100 GPU Workers (40GB/80GB VRAM)" {
  component [A100 Worker 1] as A100_1
  component [A100 Worker 2] as A100_2
  component [A100 Worker N] as A100_N
  note right of A100_1
    Image generation
    FP16 inference
    Timeout: 30 minutes
    Typical: 15-30s
    (warm containers)
  end note
}

' Frontend to API Gateway
Frontend --> Gateway : HTTP/HTTPS\n(Base64 images,\nJSON requests)

' API Gateway routing
Gateway --> SegService : POST /api/smart-mask\n(Mask generation)
Gateway --> ImageUtils : POST /api/image-utils/extract-object\n(Object extraction)
Gateway --> JobManager : POST /api/generate/async\n(Image generation)

' Job Manager to A100 Workers
JobManager --> A100_1 : Task assignment
JobManager --> A100_2 : Task assignment
JobManager --> A100_N : Task assignment

' Model loading from Volumes
SegService --> FastSAMVol : Load FastSAM model
SegService --> BiRefNetVol : Load BiRefNet model
A100_1 --> QwenVol : Load Qwen model
A100_2 --> QwenVol : Load Qwen model
A100_N --> QwenVol : Load Qwen model

' Response flow
SegService --> Gateway : Mask (base64)
ImageUtils --> Gateway : Extracted object (base64)
A100_1 --> JobManager : Generation progress (SSE)
A100_2 --> JobManager : Generation progress (SSE)
A100_N --> JobManager : Generation progress (SSE)
JobManager --> Gateway : Task status, results
Gateway --> Frontend : JSON responses,\nSSE streams

' Data flow annotations
Gateway ..> SegService : "1. Mask Generation"
SegService ..> Gateway : "Mask (base64)"
Gateway ..> ImageUtils : "2. Object Extraction"
ImageUtils ..> Gateway : "Extracted Object"
Gateway ..> JobManager : "3. Image Generation"
JobManager ..> A100_1 : "Generation Task"
A100_1 ..> JobManager : "Progress Updates (SSE)"
JobManager ..> Gateway : "Final Image"

legend right
  |<#FFE6E6> **Hardware Allocation** |
  | CPU | API Gateway, Image Utils |
  | T4 GPU (16GB) | Segmentation Service |
  | A100 GPU (40/80GB) | Image Generation |
  |
  |<#E6F3FF> **Performance** |
  | Cold-start (warm) | 1-3s |
  | Cold-start (cold) | 20-60s |
  | Typical workflow | 15-30s |
  |
  |<#E6FFE6> **Optimizations** |
  | Modal Volumes | Model caching |
  | FP16 inference | Memory & speed |
  | Async processing | No timeouts |
endlegend

@enduml

