# 1. Base Image: DÃ¹ng báº£n Runtime lÃ  chuáº©n (nháº¹ hÆ¡n báº£n devel)
FROM nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04

# 2. Thiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng quan trá»ng
# PYTHONUNBUFFERED=1: GiÃºp log hiá»‡n ngay láº­p tá»©c trÃªn RunPod (ráº¥t quan trá»ng Ä‘á»ƒ debug)
# PYTHONDONTWRITEBYTECODE=1: KhÃ´ng sinh ra file .pyc (tiáº¿t kiá»‡m chÃºt Ã­t dung lÆ°á»£ng)
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive \
    PYTORCH_ALLOC_CONF=expandable_segments:True \
    PORT=80

WORKDIR /app

# 3. CÃ i Ä‘áº·t system dependencies
# Gom nhÃ³m láº¡i vÃ  dá»n dáº¹p ngay trong cÃ¹ng 1 layer Ä‘á»ƒ giáº£m dung lÆ°á»£ng
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    libgl1 \
    libglib2.0-0 \
    python3.10 \
    python3-pip \
    # ThÃªm curl hoáº·c wget náº¿u cáº§n healthcheck sau nÃ y
    && rm -rf /var/lib/apt/lists/*

# 4. CÃ i Ä‘áº·t uv (Package manager siÃªu tá»‘c)
RUN pip install --no-cache-dir uv

# 5. Copy file dependency trÆ°á»›c
COPY pyproject.toml uv.lock* ./

# 6. CÃ i Ä‘áº·t Dependencies
# Tá»I Æ¯U HÃ“A:
# - DÃ¹ng --no-cache Ä‘á»ƒ uv khÃ´ng lÆ°u file cÃ i Ä‘áº·t táº¡m (giáº£m dung lÆ°á»£ng image Ä‘Ã¡ng ká»ƒ).
# - Chá»‰ Ä‘á»‹nh index-url cho pytorch Ä‘á»ƒ Ä‘áº£m báº£o cÃ i Ä‘Ãºng báº£n cu121 (trÃ¡nh cÃ i nháº§m báº£n cpu hoáº·c cuda khÃ¡c gÃ¢y náº·ng).
RUN echo "ðŸ“¦ Installing dependencies..." && \
    uv pip install --system --no-cache \
    --index-strategy unsafe-best-match \
    --find-links https://download.pytorch.org/whl/cu121 \
    fastapi[standard]>=0.115.0 \
    uvicorn[standard]>=0.23.0 \
    torch>=2.1.0 \
    torchvision>=0.16.0 \
    "diffusers @ git+https://github.com/huggingface/diffusers.git" \
    transformers>=4.36.0 \
    accelerate>=0.25.0 \
    bitsandbytes>=0.41.0 \
    safetensors>=0.4.1 \
    peft>=0.7.0 \
    pillow>=10.2.0 \
    numpy>=1.26.0 \
    python-multipart \
    pydantic>=2.5.0 \
    pydantic-settings \
    python-dotenv \
    "huggingface-hub[cli]" \
    requests \
    hf-xet \
    rembg \
    onnxruntime-gpu \
    torchmetrics \
    scikit-image \
    ultralytics \
    opencv-python-headless \
    pandas

# LÆ°u Ã½: MÃ¬nh Ä‘Ã£ sá»­a onnxruntime -> onnxruntime-gpu Ä‘á»ƒ táº­n dá»¥ng GPU

# 7. Copy Code (LuÃ´n Ä‘á»ƒ cuá»‘i cÃ¹ng Ä‘á»ƒ táº­n dá»¥ng Docker Layer Caching)
COPY app/ ./app/
COPY rp_handler.py ./

# 8. Run
EXPOSE 80
CMD ["python3", "rp_handler.py"]