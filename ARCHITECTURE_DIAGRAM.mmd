%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#ffffff', 'primaryTextColor':'#000000', 'primaryBorderColor':'#000000', 'lineColor':'#000000', 'secondaryColor':'#f4f4f4', 'tertiaryColor':'#e8e8e8'}}}%%

graph TB
    subgraph Frontend["Frontend (React/Next.js)"]
        FrontendClient[Frontend Client]
    end

    subgraph APIGateway["API Gateway (CPU)"]
        Gateway[API Gateway]
        GatewayNote["Cold-start: <1s<br/>Request routing<br/>CORS handling"]
        Gateway -.-> GatewayNote
    end

    subgraph ModalVolumes["Modal Volumes (Persistent Storage)"]
        QwenVol[("Qwen Model<br/>Cache")]
        FastSAMVol[("FastSAM Model<br/>Cache")]
        BiRefNetVol[("BiRefNet Model<br/>Cache")]
        VolumeNote["Reduces cold-start<br/>from 20-60s to 1-3s"]
        QwenVol -.-> VolumeNote
    end

    subgraph SegmentationService["Segmentation Service (T4 GPU, 16GB VRAM)"]
        SegService[Segmentation Service]
        SegNote["FastSAM: 1-3s<br/>BiRefNet: 3-5s<br/>Timeout: 5 minutes"]
        SegService -.-> SegNote
    end

    subgraph ImageUtilsService["Image Utils Service (CPU)"]
        ImageUtils[Image Utils Service]
        ImageUtilsNote["Object extraction<br/>Image processing"]
        ImageUtils -.-> ImageUtilsNote
    end

    subgraph JobManagerService["Job Manager Service"]
        JobManager[Job Manager]
        JobManagerNote["Task coordination<br/>Progress tracking<br/>Debug session management"]
        JobManager -.-> JobManagerNote
    end

    subgraph A100Workers["A100 GPU Workers (40GB/80GB VRAM)"]
        A100_1[A100 Worker 1]
        A100_2[A100 Worker 2]
        A100_N[A100 Worker N]
        A100Note["Image generation<br/>FP16 inference<br/>Timeout: 30 minutes<br/>Typical: 15-30s<br/>(warm containers)"]
        A100_1 -.-> A100Note
    end

    %% Frontend to API Gateway
    FrontendClient -->|"HTTP/HTTPS<br/>(Base64 images, JSON requests)"| Gateway

    %% API Gateway routing
    Gateway -->|"POST /api/smart-mask<br/>(Mask generation)"| SegService
    Gateway -->|"POST /api/image-utils/extract-object<br/>(Object extraction)"| ImageUtils
    Gateway -->|"POST /api/generate/async<br/>(Image generation)"| JobManager

    %% Job Manager to A100 Workers
    JobManager -->|"Task assignment"| A100_1
    JobManager -->|"Task assignment"| A100_2
    JobManager -->|"Task assignment"| A100_N

    %% Model loading from Volumes
    SegService -.->|"Load FastSAM model"| FastSAMVol
    SegService -.->|"Load BiRefNet model"| BiRefNetVol
    A100_1 -.->|"Load Qwen model"| QwenVol
    A100_2 -.->|"Load Qwen model"| QwenVol
    A100_N -.->|"Load Qwen model"| QwenVol

    %% Response flow
    SegService -->|"Mask (base64)"| Gateway
    ImageUtils -->|"Extracted object (base64)"| Gateway
    A100_1 -->|"Generation progress (SSE)"| JobManager
    A100_2 -->|"Generation progress (SSE)"| JobManager
    A100_N -->|"Generation progress (SSE)"| JobManager
    JobManager -->|"Task status, results"| Gateway
    Gateway -->|"JSON responses, SSE streams"| FrontendClient

    %% Data flow annotations (dashed)
    Gateway -.->|"1. Mask Generation"| SegService
    SegService -.->|"Mask (base64)"| Gateway
    Gateway -.->|"2. Object Extraction"| ImageUtils
    ImageUtils -.->|"Extracted Object"| Gateway
    Gateway -.->|"3. Image Generation"| JobManager
    JobManager -.->|"Generation Task"| A100_1
    A100_1 -.->|"Progress Updates (SSE)"| JobManager
    JobManager -.->|"Final Image"| Gateway

    %% Styling
    classDef frontendStyle fill:#E6F3FF,stroke:#000,stroke-width:2px
    classDef gatewayStyle fill:#E6FFE6,stroke:#000,stroke-width:2px
    classDef segStyle fill:#FFE6E6,stroke:#000,stroke-width:2px
    classDef imageUtilsStyle fill:#E6FFE6,stroke:#000,stroke-width:2px
    classDef jobManagerStyle fill:#F0E6FF,stroke:#000,stroke-width:2px
    classDef a100Style fill:#FFE6E6,stroke:#000,stroke-width:2px
    classDef volumeStyle fill:#FFF9E6,stroke:#000,stroke-width:2px

    class FrontendClient frontendStyle
    class Gateway gatewayStyle
    class SegService segStyle
    class ImageUtils imageUtilsStyle
    class JobManager jobManagerStyle
    class A100_1,A100_2,A100_N a100Style
    class QwenVol,FastSAMVol,BiRefNetVol volumeStyle

